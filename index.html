<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GANAè´¨æŠ¼ç®¡ç†å¹³å°</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .card-title { color: #fff; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; border: none; }
        .btn-danger { background-color: #ef4444; border: none; }
        .btn-warning { background-color: #f59e0b; border: none; color: #fff; }
        .btn-warning:hover { background-color: #d97706; color: #fff; }
        .warning-box {
            background-color: #450a0a;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #38bdf8; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; }
        
        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .table { 
            color: #cbd5e1; 
            font-size: 0.9rem; 
            width: 100%;
            table-layout: fixed;
        }
        .table thead th { 
            border-bottom: 1px solid #475569; 
            color: #94a3b8; 
            font-size: 0.8rem; 
            padding: 8px 2px;
            text-align: center;
            white-space: nowrap;
        }
        .table td { 
            border-bottom: 1px solid #334155; 
            vertical-align: middle;
            padding: 8px 2px;
            text-align: center;
            word-break: break-word;
        }

        /* åˆ—å®½è®¾ç½® - ä¼˜åŒ–ç‰ˆ */
        .table th:nth-child(1), .table td:nth-child(1) { width: 5%; }  /* IDåˆ— - ç¼©å° */
        .table th:nth-child(2), .table td:nth-child(2) { width: 12%; }  /* é‡‘é¢åˆ— */
        .table th:nth-child(3), .table td:nth-child(3) { width: 10%; } /* å‘¨æœŸåˆ— */
        .table th:nth-child(4), .table td:nth-child(4) { width: 25%; } /* è´¨æŠ¼æ—¶é—´ */
        .table th:nth-child(5), .table td:nth-child(5) { width: 20%; } /* å‰©ä½™æ—¶é—´ - åˆ†ä¸¤è¡Œ */
        .table th:nth-child(6), .table td:nth-child(6) { width: 12%; } /* çŠ¶æ€åˆ— */
        .table th:nth-child(7), .table td:nth-child(7) { width: 16%; } /* æ“ä½œåˆ— */

        /* IDåˆ—æ ·å¼ - å–æ¶ˆæ ‡ç­¾ï¼Œé»‘è‰²å­—ä½“ï¼Œå‡å° */
        .id-value {
            font-size: 0.75rem;
            color: #94a3b8; /* ç°è‰² */
            font-weight: normal;
        }

        /* é‡‘é¢åˆ—æ ·å¼ - è°ƒå¤§ä¸€ç‚¹ï¼Œçº¢è‰² */
        .amount-value {
            font-size: 0.9rem;
            color: #f87171; /* çº¢è‰² */
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        /* å‘¨æœŸæ ‡ç­¾ */
        .badge-duration { 
            background-color: #374151; 
            color: #9ca3af; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.75rem;
            white-space: nowrap;
            display: inline-block;
            font-weight: 500;
        }
        
        /* æ—¶é—´åŒè¡Œæ˜¾ç¤º */
        .time-two-lines {
            display: flex;
            flex-direction: column;
            line-height: 1.4;
        }
        .time-date {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        .time-clock {
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            font-weight: 500;
            color: #f87171;
        }
        
        /* å‰©ä½™æ—¶é—´åŒè¡Œæ˜¾ç¤º */
        .remaining-two-lines {
            display: flex;
            flex-direction: column;
            line-height: 1.4;
        }
        .remaining-top {
            font-size: 0.8rem;
            color: #f87171; /* çº¢è‰² */
            font-weight: 500;
        }
        .remaining-bottom {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        /* å·²è§£é”çŠ¶æ€çš„ç‰¹æ®Šæ ·å¼ */
        .remaining-top.unlocked {
            color: #34d399; /* ç»¿è‰² */
        }
        
        /* å€’è®¡æ—¶æ ·å¼ - ç§»é™¤åŸæœ‰æ ·å¼ï¼Œä½¿ç”¨æ–°çš„åŒè¡Œæ ·å¼ */
        .countdown { 
            display: inline-block;
            width: 100%;
        }
        
        input.form-control { background-color: #334155; border-color: #475569; color: white; }
        input.form-control:focus { background-color: #334155; color: white; border-color: #38bdf8; box-shadow: none; }
        .staking-btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .staking-btn-group .btn { flex: 1; min-width: 120px; }
        
        .align-items-end label.form-label { color: wheat; }
        
        /* è°ƒæ•´è¡¨æ ¼ä¸­ç‰¹å®šåˆ—çš„å­—ä½“å¤§å° */
        .stake-time-cell { 
            white-space: normal; 
        }
        .remaining-time-cell { 
            white-space: normal; 
        }
        .status-cell { 
            font-size: 0.8rem; 
            white-space: normal; 
            word-break: break-word;
            line-height: 1.3;
        }
        .action-cell { 
            font-size: 0.8rem; 
            white-space: normal; 
            word-break: break-word;
        }
        
        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-cell span {
            display: inline-block;
            max-width: 100%;
            word-break: break-word;
            line-height: 1.4;
        }
        
        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-cell .btn-sm { 
            padding: 0.15rem 0.3rem; 
            font-size: 0.7rem; 
            line-height: 1.3;
            white-space: normal;
            word-break: break-word;
            max-width: 100%;
            height: auto;
            min-height: 28px;
        }
        
        /* å·²æå–çŠ¶æ€çš„ç‰¹æ®Šæ ·å¼ */
        .action-cell .btn-sm.btn-secondary {
            white-space: normal;
            word-break: break-word;
            height: auto;
            padding: 0.15rem 0.2rem;
        }
        
        /* è°ƒæ•´è¡¨æ ¼è¡Œé«˜ */
        .table tbody tr { height: auto; min-height: 60px; }
        
        /* é€‰é¡¹å¡æ ·å¼ */
        .nav-tabs { border-bottom: 1px solid #334155; }
        .nav-tabs .nav-link { 
            color: #94a3b8; 
            border: 1px solid transparent;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        .nav-tabs .nav-link:hover { 
            color: #cbd5e1; 
            border-color: #475569;
        }
        .nav-tabs .nav-link.active { 
            color: #38bdf8; 
            background-color: #1e293b; 
            border-color: #475569 #475569 #1e293b;
        }
        .tab-content { padding-top: 1rem; }
        
        /* æˆ‘çš„è´¨æŠ¼è®°å½•å­é€‰é¡¹å¡æ ·å¼ */
        .sub-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }
        .sub-tab {
            background-color: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 4px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .sub-tab:hover {
            background-color: #334155;
            color: #e2e8f0;
        }
        .sub-tab.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .address-short { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.8rem;
        }
        .total-stats-card { border-left: 4px solid #3b82f6; }
        .contract-address { 
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 500;
            color: #60a5fa;
            word-break: break-all;
            background-color: #1f2937;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        /* ç¼“å­˜çŠ¶æ€æç¤º */
        .cache-status {
            font-size: 0.7rem;
            color: #6b7280;
            margin-left: 10px;
        }
        
        /* è®°å½•é¡¹é«˜äº® */
        @keyframes highlight {
            0% { background-color: #3b82f6; }
            100% { background-color: transparent; }
        }
        .record-highlight {
            animation: highlight 1s ease-out;
        }
        
        /* åŠ è½½è¿›åº¦æç¤º */
        .loading-progress {
            margin-top: 10px;
            padding: 10px;
            background-color: #1e293b;
            border-radius: 5px;
            font-size: 0.85rem;
            color: #38bdf8;
            text-align: center;
        }
        
        /* è¡¨æ ¼å®¹å™¨ */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>

    <!-- åˆçº¦åœ°å€ä¿¡æ¯ -->
    <div class="alert alert-info mb-4">
        <h6 class="fw-bold">åˆçº¦åœ°å€ä¿¡æ¯</h6>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-2">
                    <small class="text-muted">è´¨æŠ¼åˆçº¦ï¼š</small>
                    <div class="contract-address" id="stakingContractAddress">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-2">
                    <small class="text-muted">LPæ± åˆçº¦ï¼š</small>
                    <div class="contract-address" id="lpContractAddress">0xa2f464a2462aed49b9b31eb8861bc6b0bbb0483f</div>
                </div>
            </div>
        </div>
    </div>

    <!-- é’±åŒ…è¿æ¥ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">GANAè´¨æŠ¼ç®¡ç†å¹³å°</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
    <div class="row mb-4 text-center g-2">
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">æˆ‘çš„ USDT ä½™é¢</div>
                <div class="stat-value" id="myBalance">0.00</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¾…æç°ä½™é¢ (åˆçº¦å†…)</div>
                <div class="stat-value" id="stakedBalance">0.00</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¯æç° USDT (æ± å­)</div>
                <div class="stat-value" id="poolBalance">0.00</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">åˆçº¦æ€»è´¨æŠ¼</div>
                <div class="stat-value" id="totalStaked">0.00</div>
            </div>
        </div>
    </div>

    <!-- è´¨æŠ¼æ“ä½œåŒºåŸŸ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">å‚ä¸è´¨æŠ¼</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">è´¨æŠ¼é‡‘é¢ (USDT)</label>
                    <input type="number" class="form-control" id="stakeAmount" value="1000" placeholder="è¾“å…¥é‡‘é¢">
                </div>
                <div class="col-md-6">
                    <label class="form-label d-block">é€‰æ‹©è´¨æŠ¼å‘¨æœŸ</label>
                    <div class="staking-btn-group">
                        <button class="btn btn-success" onclick="handleStake(0, 1)">1å¤©(0.4%)</button>
                        <button class="btn btn-success" onclick="handleStake(1, 15)">15å¤©(0.8%)</button>
                        <button class="btn btn-success" onclick="handleStake(2, 30)">30å¤©(1.3%)</button>
                    </div>
                </div>
            </div>
            <div class="mt-2 small text-white">
                * æ³¨æ„ï¼šä¸åŒè´¨æŠ¼å‘¨æœŸçš„æ—¥åŒ–ç‡å’Œè§£é”æ—¶é—´ä¸åŒ
            </div>
        </div>
    </div>

    <!-- è´¨æŠ¼è®°å½•åŒºåŸŸï¼ˆé€‰é¡¹å¡ï¼‰ -->
    <div class="card">
        <div class="card-body">
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <ul class="nav nav-tabs" id="stakeTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="my-stake-tab" data-bs-toggle="tab" data-bs-target="#my-stake" type="button" role="tab" aria-controls="my-stake" aria-selected="true">æˆ‘çš„è´¨æŠ¼è®°å½• <span id="myStakeCount" class="badge bg-secondary ms-1">0</span></button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-stake-tab" data-bs-toggle="tab" data-bs-target="#all-stake" type="button" role="tab" aria-controls="all-stake" aria-selected="false">åˆçº¦æ€»è´¨æŠ¼è®°å½•</button>
                </li>
            </ul>
            
            <!-- é€‰é¡¹å¡å†…å®¹ -->
            <div class="tab-content" id="stakeTabContent">
                <!-- æˆ‘çš„è´¨æŠ¼è®°å½• -->
                <div class="tab-pane fade show active" id="my-stake" role="tabpanel" aria-labelledby="my-stake-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                        <h5 class="card-title mb-0">
                            æˆ‘çš„è´¨æŠ¼è®°å½•
                            <span class="cache-status" id="cacheStatus"></span>
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshData()">åˆ·æ–°å…¨éƒ¨</button>
                            <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleAutoRefresh()" id="autoRefreshBtn">è‡ªåŠ¨åˆ·æ–°: å…³é—­</button>
                        </div>
                    </div>
                    
                    <!-- æˆ‘çš„è´¨æŠ¼è®°å½•å­é€‰é¡¹å¡ -->
                    <div class="sub-tabs">
                        <span class="sub-tab active" onclick="filterMyStakes('all')" id="filter-all">å…¨éƒ¨</span>
                        <span class="sub-tab" onclick="filterMyStakes('active')" id="filter-active">æœªèµå›</span>
                        <span class="sub-tab" onclick="filterMyStakes('inactive')" id="filter-inactive">å·²èµå›</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>é‡‘é¢</th>
                                    <th>å‘¨æœŸ</th>
                                    <th>è´¨æŠ¼æ—¶é—´</th>
                                    <th>å‰©ä½™æ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="stakeListBody">
                                <tr><td colspan="7" class="text-center">è¯·è¿æ¥é’±åŒ…æŸ¥çœ‹æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- åˆçº¦æ€»è´¨æŠ¼è®°å½• -->
                <div class="tab-pane fade" id="all-stake" role="tabpanel" aria-labelledby="all-stake-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                        <h5 class="card-title mb-0">åˆçº¦æ€»è´¨æŠ¼è®°å½•</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshAllStakeData()">åˆ·æ–°æ€»è´¨æŠ¼</button>
                        </div>
                    </div>
                    
                    <!-- æ€»è´¨æŠ¼ç»Ÿè®¡ -->
                    <div class="row mb-4 text-center g-2">
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">æ€»è´¨æŠ¼ç”¨æˆ·æ•°</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">æ´»è·ƒè´¨æŠ¼æ•°é‡</div>
                                <div class="stat-value" id="activeStakes">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">å¹³å‡è´¨æŠ¼é‡‘é¢</div>
                                <div class="stat-value" id="avgStakeAmount">0.00</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">æ€»è´¨æŠ¼æ¬¡æ•°</div>
                                <div class="stat-value" id="totalStakeCount">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŠ è½½è¿›åº¦æç¤º -->
                    <div id="loadingProgress" class="loading-progress" style="display: none;"></div>
                    
                    <!-- æ€»è´¨æŠ¼åˆ—è¡¨ -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>åºå·</th>
                                    <th>ç”¨æˆ·åœ°å€</th>
                                    <th>é‡‘é¢</th>
                                    <th>å‘¨æœŸ</th>
                                    <th>è´¨æŠ¼æ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="allStakeListBody">
                                <tr><td colspan="6" class="text-center">ç‚¹å‡»"åˆ·æ–°æ€»è´¨æŠ¼"æŸ¥çœ‹åˆçº¦æ€»è´¨æŠ¼è®°å½•</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-white small">
                            æ˜¾ç¤º <span id="currentPage">1</span> / <span id="totalPages">1</span> é¡µ
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="prevPage()" id="prevPageBtn" disabled>ä¸Šä¸€é¡µ</button>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="nextPage()" id="nextPageBtn" disabled>ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Bootstrap JS ç”¨äºé€‰é¡¹å¡åŠŸèƒ½ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        STAKING: "0x72212F35aC448FE7763aA1BFdb360193Fa098E52",
        USDT: "0x55d398326f99059fF775485246999027B3197955",
        PAIR: "0xa2f464a2462aed49b9b31eb8861bc6b0bbb0483f",
        TOTAL_STAKE_PAGE_SIZE: 10
    };
    
    // è´¨æŠ¼å‘¨æœŸé…ç½® (ç§’)
    const STAKE_DURATIONS = {
        0: 86400,
        1: 1296000,
        2: 2592000
    };
    
    const STAKE_DURATION_LABELS = {
        0: "1å¤©",
        1: "15å¤©", 
        2: "30å¤©"
    };
    // ===========================================

    // ABIs
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    const ABI_STAKING = [{"inputs":[{"internalType":"address","name":"marketingAddress_","type":"address"},{"internalType":"address","name":"devAddress_","type":"address"},{"internalType":"address","name":"threesevenAddress_","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"}],"name":"PRBMath_MulDiv18_Overflow","type":"error"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"uint256","name":"denominator","type":"uint256"}],"name":"PRBMath_MulDiv_Overflow","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"uint40","name":"timestamp","type":"uint40"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"}],"name":"RewardPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stakeTime","type":"uint256"}],"name":"Staked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"GANA","outputs":[{"internalType":"contract IGANA","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_STAKE_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"back_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"devAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"isPreacher","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"market_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"marketingAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxStakeAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"network1In","outputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint8","name":"index","type":"uint8"}],"name":"principalPlusRewardOfSlot","outputs":[{"internalType":"uint256","name":"reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratePerSec","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_gana","type":"address"}],"name":"setGANA","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint160","name":"_amount","type":"uint160"},{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"uint8","name":"_stakeIndex","type":"uint8"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"stakeCount","outputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"sync","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"t_supply","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"tamount","type":"uint160"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"threesevenAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"threeseven_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"unstake","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userStakeRecord","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"amount","type":"uint160"},{"internalType":"bool","name":"status","type":"bool"},{"internalType":"uint8","name":"stakeIndex","type":"uint8"}],"stateMutability":"view","type":"function"}];

    // å…¨å±€å˜é‡
    let provider, signer, userAddress;
    let stakingContract, usdtContract;
    let autoRefreshInterval = null;
    let countdownTimers = {};
    
    // æ€»è´¨æŠ¼è®°å½•ç›¸å…³å˜é‡
    let allStakeData = [];
    let currentPage = 1;
    let totalPages = 1;
    let isLoadingAllData = false;

    // æˆ‘çš„è´¨æŠ¼è®°å½•ç¼“å­˜
    let myStakeRecords = [];
    let lastFetchTime = 0;
    let pendingUpdates = new Set();
    let currentFilter = 'all';

    // å·¥å…·å‡½æ•°
    function formatAmountInteger(wei) {
        try {
            const val = ethers.formatUnits(wei, 18);
            return Math.floor(parseFloat(val)).toString();
        } catch (e) {
            return "0";
        }
    }

    function formatAmountTwoDecimals(wei) {
        try {
            const val = ethers.formatUnits(wei, 18);
            return parseFloat(val).toFixed(2);
        } catch (e) {
            return "0.00";
        }
    }

    // æ˜¾ç¤ºå‰©ä½™æ—¶é—´ - åˆ†ä¸¤è¡Œï¼šå¤©å’Œå°æ—¶åœ¨ä¸Šé¢ï¼Œåˆ†å’Œç§’åœ¨ä¸‹é¢
    function formatTimeRemainingSplit(seconds) {
        if (seconds <= 0) return { top: "0ç§’", bottom: "" };
        
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let topPart = "";
        let bottomPart = "";
        
        if (days > 0) topPart += `${days}å¤©`;
        if (hours > 0) topPart += `${hours}å°æ—¶`;
        
        if (minutes > 0) bottomPart += `${minutes}åˆ†`;
        if (secs > 0) bottomPart += `${secs}ç§’`;
        
        if (topPart === "" && bottomPart === "") {
            return { top: "0ç§’", bottom: "" };
        }
        
        return { top: topPart || "0å°æ—¶", bottom: bottomPart || "0ç§’" };
    }
    
    // è¿”å›æ—¥æœŸå’Œæ—¶é—´åˆ†å¼€
    function formatStakeTimeSplit(timestamp) {
        try {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            let dateStr = '';
            if (diffDays === 0) {
                dateStr = 'ä»Šå¤©';
            } else if (diffDays === 1) {
                dateStr = 'æ˜¨å¤©';
            } else {
                dateStr = date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            }
            
            const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            return { date: dateStr, time: timeStr };
        } catch (e) {
            return { date: "é”™è¯¯", time: "é”™è¯¯" };
        }
    }
    
    function shortenAddress(address) {
        if (!address) return '';
        return address.substring(0, 6) + '...' + address.substring(address.length - 4);
    }

    // è¿æ¥é’±åŒ…
    async function connectWallet() {
        if (!window.ethereum) {
            alert("è¯·å®‰è£… MetaMask!");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            document.getElementById('connectBtn').innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

            await refreshData();
        } catch (error) {
            console.error("è¿æ¥å¤±è´¥:", error);
            alert("è¿æ¥é’±åŒ…å¤±è´¥: " + (error.message || error));
        }
    }

    // æ›´æ–°ç¼“å­˜çŠ¶æ€
    function updateCacheStatus() {
        const cacheStatusEl = document.getElementById('cacheStatus');
        if (!cacheStatusEl) return;
        const now = Date.now();
        if (lastFetchTime === 0) {
            cacheStatusEl.textContent = 'æœªåŠ è½½';
        } else if (pendingUpdates.size > 0) {
            cacheStatusEl.textContent = `ğŸ”„ æ›´æ–°ä¸­ (${pendingUpdates.size}æ¡)`;
        } else {
            cacheStatusEl.textContent = `â±ï¸ ${Math.round((now - lastFetchTime)/1000)}ç§’å‰æ›´æ–°`;
        }
    }

    async function updateSingleRecord(index) {
        if (!userAddress || !stakingContract) return null;
        try {
            const record = await stakingContract.userStakeRecord(userAddress, index);
            const now = Math.floor(Date.now() / 1000);
            const amount = formatAmountInteger(record[1]);
            const stakeTime = Number(record[0]);
            const isActive = record[2];
            const stakeIndex = Number(record[3]);
            const durationSeconds = STAKE_DURATIONS[stakeIndex] || 86400;
            const unlockTime = stakeTime + durationSeconds;
            const timeRemaining = unlockTime - now;
            
            const updatedRecord = { index, amount, stakeTime, isActive, stakeIndex, unlockTime, timeRemaining };
            
            const existingIndex = myStakeRecords.findIndex(r => r.index === index);
            if (existingIndex >= 0) {
                myStakeRecords[existingIndex] = updatedRecord;
            } else {
                myStakeRecords.push(updatedRecord);
            }
            myStakeRecords.sort((a, b) => b.index - a.index);
            return updatedRecord;
        } catch (error) {
            return null;
        }
    }

    async function refreshChangedRecords() {
        if (!userAddress || !stakingContract) return;
        const changedIndices = Array.from(pendingUpdates);
        if (changedIndices.length === 0) return;
        updateCacheStatus();
        await Promise.all(changedIndices.map(index => updateSingleRecord(parseInt(index))));
        pendingUpdates.clear();
        renderStakeListFromCache();
        updateCacheStatus();
    }

    function filterMyStakes(filter) {
        currentFilter = filter;
        document.getElementById('filter-all').classList.remove('active');
        document.getElementById('filter-active').classList.remove('active');
        document.getElementById('filter-inactive').classList.remove('active');
        document.getElementById(`filter-${filter}`).classList.add('active');
        renderStakeListFromCache();
    }

    function renderStakeListFromCache() {
        const tbody = document.getElementById('stakeListBody');
        if (!tbody) return;
        
        let filteredRecords = myStakeRecords;
        if (currentFilter === 'active') {
            filteredRecords = myStakeRecords.filter(r => !r.isActive);
        } else if (currentFilter === 'inactive') {
            filteredRecords = myStakeRecords.filter(r => r.isActive);
        }
        
        if (filteredRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">æš‚æ— è´¨æŠ¼è®°å½•</td></tr>';
            document.getElementById('myStakeCount').textContent = myStakeRecords.length;
            return;
        }
        
        const now = Math.floor(Date.now() / 1000);
        let html = '';
        
        filteredRecords.forEach(record => {
            const isLocked = record.timeRemaining > 0 && !record.isActive;
            const isUnlocked = record.timeRemaining <= 0 && !record.isActive;
            const durationLabel = STAKE_DURATION_LABELS[record.stakeIndex] || "æœªçŸ¥";
            const timeObj = formatStakeTimeSplit(record.stakeTime);
            const timeRemainingObj = formatTimeRemainingSplit(record.timeRemaining);
            
            let statusHtml = '';
            let actionHtml = '';
            let timeRemainingHtml = '';

            if (record.isActive) {
                statusHtml = '<span class="text-muted">å·²æå–</span>';
                actionHtml = '-';
                timeRemainingHtml = '<span class="text-muted">-</span>';
            } else {
                if (isLocked) {
                    statusHtml = '<span class="text-danger">é”ä»“ä¸­</span>';
                    actionHtml = `<button class="btn btn-sm btn-secondary" disabled>ç­‰å¾…è§£é”</button>`;
                    timeRemainingHtml = `
                        <div class="remaining-two-lines">
                            <span class="remaining-top">${timeRemainingObj.top}</span>
                            <span class="remaining-bottom">${timeRemainingObj.bottom}</span>
                        </div>
                    `;
                    startCountdown(record.index, record.timeRemaining);
                } else if (isUnlocked) {
                    statusHtml = '<span class="text-success">å¯èµå›</span>';
                    actionHtml = `<button class="btn btn-sm btn-warning" id="unstake-btn-${record.index}" onclick="handleUnstake(${record.index})">ç«‹å³èµå›</button>`;
                    timeRemainingHtml = '<span class="remaining-top unlocked">å·²è§£é”</span>';
                } else {
                    statusHtml = '<span class="text-warning">æœªçŸ¥</span>';
                    actionHtml = '-';
                    timeRemainingHtml = '-';
                }
            }

            html += `
                <tr id="record-row-${record.index}" ${pendingUpdates.has(record.index.toString()) ? 'class="record-highlight"' : ''}>
                    <td><span class="id-value">${record.index}</span></td>
                    <td><span class="amount-value">${record.amount}</span></td>
                    <td><span class="badge-duration">${durationLabel}</span></td>
                    <td class="stake-time-cell">
                        <div class="time-two-lines">
                            <span class="time-date">${timeObj.date}</span>
                            <span class="time-clock">${timeObj.time}</span>
                        </div>
                    </td>
                    <td class="remaining-time-cell">${timeRemainingHtml}</td>
                    <td class="status-cell">${statusHtml}</td>
                    <td class="action-cell">${actionHtml}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
        document.getElementById('myStakeCount').textContent = myStakeRecords.length;
        
        setTimeout(() => {
            document.querySelectorAll('.record-highlight').forEach(el => el.classList.remove('record-highlight'));
        }, 1000);
    }

    // è´¨æŠ¼æ“ä½œ
    async function handleStake(stakeIndex, durationDays) {
        if (!userAddress) return alert("è¯·å…ˆè¿æ¥é’±åŒ…");
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
        const amountWei = ethers.parseUnits(amountStr, 18);
        
        const buttons = document.querySelectorAll('.staking-btn-group .btn');
        const originalTexts = [];
        
        try {
            buttons.forEach(btn => {
                originalTexts.push(btn.textContent);
                btn.disabled = true;
            });
            
            const currentBtn = event.target;
            currentBtn.textContent = "æ£€æŸ¥é™é¢...";

            const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
            if (allowance < amountWei) {
                currentBtn.textContent = "æ­£åœ¨æˆæƒ USDT...";
                const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256); 
                await txApprove.wait();
            }

            currentBtn.textContent = "æ­£åœ¨è´¨æŠ¼...";
            const txStake = await stakingContract.stake(amountWei, 0, stakeIndex);
            await txStake.wait();
            
            const newCount = await stakingContract.stakeCount(userAddress);
            const newIndex = Number(newCount) - 1;
            pendingUpdates.add(newIndex.toString());
            
            await refreshStatsOnly();
            await refreshChangedRecords();
            
            alert(`è´¨æŠ¼æˆåŠŸï¼å‘¨æœŸï¼š${durationDays}å¤©`);
        } catch (error) {
            console.error(error);
            alert("è´¨æŠ¼å¤±è´¥: " + (error.message || error));
        } finally {
            buttons.forEach((btn, index) => {
                btn.disabled = false;
                btn.textContent = originalTexts[index];
            });
        }
    }

    async function refreshStatsOnly() {
        if (!userAddress) return;
        try {
            const [myBal, stakedBal, poolBal, totalStaked] = await Promise.all([
                usdtContract.balanceOf(userAddress),
                stakingContract.balanceOf(userAddress),
                usdtContract.balanceOf(CONFIG.PAIR),
                stakingContract.totalSupply()
            ]);
            document.getElementById('myBalance').innerText = formatAmountTwoDecimals(myBal);
            document.getElementById('stakedBalance').innerText = formatAmountTwoDecimals(stakedBal);
            document.getElementById('poolBalance').innerText = formatAmountTwoDecimals(poolBal);
            document.getElementById('totalStaked').innerText = formatAmountTwoDecimals(totalStaked);
        } catch (error) {
            console.error("ç»Ÿè®¡åˆ·æ–°å¤±è´¥:", error);
        }
    }

    async function handleUnstake(index) {
        if (!userAddress) return;
        const btn = document.getElementById(`unstake-btn-${index}`);
        if(btn) {
            btn.disabled = true;
            btn.innerText = "å¤„ç†ä¸­...";
        }
        try {
            const tx = await stakingContract.unstake(index);
            await tx.wait();
            pendingUpdates.add(index.toString());
            await refreshStatsOnly();
            await refreshChangedRecords();
            alert("èµå›æˆåŠŸï¼");
        } catch (error) {
            console.error(error);
            alert("èµå›å¤±è´¥: " + (error.message || error));
            if(btn) {
                btn.disabled = false;
                btn.innerText = "èµå›";
            }
        }
    }

    async function refreshData() {
        if (!userAddress) return;
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn.innerText;
        btn.innerText = "åŠ è½½ä¸­...";
        
        try {
            await refreshStatsOnly();
            const newCount = await stakingContract.stakeCount(userAddress);
            if (myStakeRecords.length !== Number(newCount)) {
                for (let i = 0; i < Number(newCount); i++) {
                    pendingUpdates.add(i.toString());
                }
            }
            await refreshChangedRecords();
            lastFetchTime = Date.now();
            updateCacheStatus();
        } catch (error) {
            console.error("æ•°æ®åŠ è½½é”™è¯¯:", error);
        } finally {
            btn.innerText = originalText;
        }
    }

    function startCountdown(id, initialSeconds) {
        let remaining = initialSeconds;
        const countdownElement = document.getElementById(`countdown-${id}`);
        if (!countdownElement) return;
        
        // æ‰¾åˆ°å¯¹åº”çš„çˆ¶å…ƒç´ 
        const cellElement = countdownElement.closest('.remaining-time-cell');
        
        const timer = setInterval(() => {
            remaining--;
            if (remaining <= 0) {
                clearInterval(timer);
                pendingUpdates.add(id.toString());
                refreshChangedRecords();
                return;
            }
            
            // æ›´æ–°æ˜¾ç¤º
            if (cellElement) {
                const timeRemainingObj = formatTimeRemainingSplit(remaining);
                const topSpan = cellElement.querySelector('.remaining-top');
                const bottomSpan = cellElement.querySelector('.remaining-bottom');
                if (topSpan && bottomSpan) {
                    topSpan.textContent = timeRemainingObj.top;
                    bottomSpan.textContent = timeRemainingObj.bottom;
                }
            }
        }, 1000);
        countdownTimers[id] = timer;
    }

    // å…¨ç½‘è´¨æŠ¼è®°å½•åˆ·æ–°å‡½æ•°
    async function refreshAllStakeData() {
        if (!stakingContract) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        if (isLoadingAllData) return;
        
        const btn = document.querySelector('button[onclick="refreshAllStakeData()"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "åŠ è½½ä¸­...";
        isLoadingAllData = true;
        
        const progressEl = document.getElementById('loadingProgress');
        if (progressEl) progressEl.style.display = 'block';
        
        try {
            allStakeData = [];
            
            const currentBlock = await provider.getBlockNumber();
            console.log("å½“å‰åŒºå—é«˜åº¦:", currentBlock);
            
            const BATCH_SIZE = 2000;
            let fromBlock = Math.max(0, currentBlock - 50000);
            let toBlock = Math.min(fromBlock + BATCH_SIZE - 1, currentBlock);
            let totalEvents = 0;
            let batchCount = 0;
            
            const totalBatches = Math.ceil((currentBlock - fromBlock + 1) / BATCH_SIZE);
            
            while (fromBlock <= currentBlock) {
                batchCount++;
                const progress = Math.round((batchCount / totalBatches) * 100);
                
                if (progressEl) {
                    progressEl.innerHTML = `æ­£åœ¨åŠ è½½å†å²æ•°æ®... ${progress}% (ç¬¬ ${batchCount}/${totalBatches} æ‰¹)`;
                }
                
                console.log(`æŸ¥è¯¢åŒºå— ${fromBlock} åˆ° ${toBlock} (æ‰¹æ¬¡ ${batchCount}/${totalBatches})`);
                
                try {
                    const filter = stakingContract.filters.Staked();
                    const events = await stakingContract.queryFilter(filter, fromBlock, toBlock);
                    
                    console.log(`æ‰¾åˆ° ${events.length} æ¡äº‹ä»¶`);
                    totalEvents += events.length;
                    
                    for (const event of events) {
                        try {
                            if (event.args) {
                                const amount = event.args[0];
                                const user = event.args[1];
                                const stakeIndex = Number(event.args[2]);
                                const stakeTime = Number(event.args[3]);
                                
                                let isActive = true;
                                try {
                                    const record = await stakingContract.userStakeRecord(user, stakeIndex);
                                    isActive = record[2];
                                } catch (e) {}
                                
                                allStakeData.push({
                                    userAddress: user,
                                    amount: amount,
                                    stakeTime: stakeTime,
                                    isActive: isActive,
                                    stakeIndex: stakeIndex
                                });
                            }
                        } catch (eventError) {}
                    }
                    
                    fromBlock = toBlock + 1;
                    toBlock = Math.min(fromBlock + BATCH_SIZE - 1, currentBlock);
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                } catch (batchError) {
                    console.error(`æ‰¹æ¬¡æŸ¥è¯¢å¤±è´¥:`, batchError);
                    fromBlock = toBlock + 1;
                    toBlock = Math.min(fromBlock + BATCH_SIZE - 1, currentBlock);
                }
            }
            
            console.log(`æ€»å…±æ‰¾åˆ° ${totalEvents} æ¡äº‹ä»¶`);
            
            allStakeData.sort((a, b) => b.stakeTime - a.stakeTime);
            
            calculateAllStats();
            
            currentPage = 1;
            renderAllStakeList();
            updatePagination();
            
            if (progressEl) {
                progressEl.innerHTML = `åŠ è½½å®Œæˆï¼å…± ${allStakeData.length} æ¡è®°å½•`;
                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 3000);
            }
            
            btn.innerText = "åˆ·æ–°æˆåŠŸ";
            
        } catch (error) {
            console.error("è·å–å…¨ç½‘è´¨æŠ¼æ•°æ®å¤±è´¥:", error);
            btn.innerText = "åˆ·æ–°å¤±è´¥";
            
            if (progressEl) {
                progressEl.innerHTML = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                progressEl.style.color = '#ef4444';
            }
        } finally {
            setTimeout(() => {
                btn.disabled = false;
                btn.innerText = originalText;
                isLoadingAllData = false;
            }, 2000);
        }
    }
    
    // è®¡ç®—ç»Ÿè®¡
    function calculateAllStats() {
        if (allStakeData.length === 0) {
            document.getElementById('totalUsers').textContent = '0';
            document.getElementById('activeStakes').textContent = '0';
            document.getElementById('avgStakeAmount').textContent = '0.00';
            document.getElementById('totalStakeCount').textContent = '0';
            return;
        }
        
        const uniqueUsers = new Set(allStakeData.map(r => r.userAddress));
        document.getElementById('totalUsers').textContent = uniqueUsers.size;
        
        const activeStakes = allStakeData.filter(r => !r.isActive).length;
        document.getElementById('activeStakes').textContent = activeStakes;
        
        document.getElementById('totalStakeCount').textContent = allStakeData.length;
        
        const totalAmount = allStakeData.reduce((sum, r) => {
            return sum + parseFloat(ethers.formatUnits(r.amount, 18));
        }, 0);
        document.getElementById('avgStakeAmount').textContent = (totalAmount / allStakeData.length).toFixed(2);
    }
    
    // æ¸²æŸ“æ€»è´¨æŠ¼åˆ—è¡¨
    function renderAllStakeList() {
        const tbody = document.getElementById('allStakeListBody');
        if (allStakeData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">æš‚æ— è´¨æŠ¼è®°å½•</td></tr>';
            return;
        }
        
        const startIndex = (currentPage - 1) * CONFIG.TOTAL_STAKE_PAGE_SIZE;
        const endIndex = Math.min(startIndex + CONFIG.TOTAL_STAKE_PAGE_SIZE, allStakeData.length);
        const pageData = allStakeData.slice(startIndex, endIndex);
        
        let html = '';
        pageData.forEach((record, index) => {
            const globalIndex = startIndex + index + 1;
            const amount = formatAmountInteger(record.amount);
            const timeObj = formatStakeTimeSplit(record.stakeTime);
            const durationLabel = STAKE_DURATION_LABELS[record.stakeIndex] || "æœªçŸ¥";
            const status = record.isActive ? "å·²æå–" : "è´¨æŠ¼ä¸­";
            const statusClass = record.isActive ? "text-muted" : "text-success";
            const isCurrentUser = record.userAddress.toLowerCase() === (userAddress || '').toLowerCase();
            
            html += `
                <tr>
                    <td>${globalIndex}</td>
                    <td><span class="address-short">${shortenAddress(record.userAddress)}</span>${isCurrentUser ? '<span class="badge bg-info ms-2">æˆ‘</span>' : ''}</td>
                    <td><span class="amount-value">${amount}</span></td>
                    <td><span class="badge-duration">${durationLabel}</span></td>
                    <td class="stake-time-cell">
                        <div class="time-two-lines">
                            <span class="time-date">${timeObj.date}</span>
                            <span class="time-clock">${timeObj.time}</span>
                        </div>
                    </td>
                    <td class="status-cell"><span class="${statusClass}">${status}</span></td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    function updatePagination() {
        totalPages = Math.ceil(allStakeData.length / CONFIG.TOTAL_STAKE_PAGE_SIZE);
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages || 1;
        document.getElementById('prevPageBtn').disabled = currentPage <= 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }
    
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderAllStakeList();
            updatePagination();
        }
    }
    
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderAllStakeList();
            updatePagination();
        }
    }
    
    // è‡ªåŠ¨åˆ·æ–°
    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(async () => {
            if (userAddress) {
                const newCount = await stakingContract.stakeCount(userAddress);
                if (myStakeRecords.length !== Number(newCount)) {
                    for (let i = 0; i < Number(newCount); i++) {
                        if (!myStakeRecords.some(r => r.index === i)) {
                            pendingUpdates.add(i.toString());
                        }
                    }
                }
                await refreshChangedRecords();
                await refreshStatsOnly();
            }
        }, 30000);
    }

    function toggleAutoRefresh() {
        const btn = document.getElementById('autoRefreshBtn');
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.textContent = "è‡ªåŠ¨åˆ·æ–°: å…³é—­";
            btn.classList.remove('btn-info');
            btn.classList.add('btn-outline-info');
        } else {
            startAutoRefresh();
            btn.textContent = "è‡ªåŠ¨åˆ·æ–°: å¼€å¯";
            btn.classList.remove('btn-outline-info');
            btn.classList.add('btn-info');
        }
    }

    // æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        Object.keys(countdownTimers).forEach(id => clearInterval(countdownTimers[id]));
    });

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) connectWallet();
                });
        }
        document.getElementById('stakingContractAddress').textContent = CONFIG.STAKING;
        document.getElementById('lpContractAddress').textContent = CONFIG.PAIR;
    });
</script>
</body>
</html>
