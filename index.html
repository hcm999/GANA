<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GANAè´¨æŠ¼ç®¡ç†å¹³å°</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .card-title { color: #fff; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; border: none; }
        .btn-danger { background-color: #ef4444; border: none; }
        .btn-warning { background-color: #f59e0b; border: none; color: #fff; }
        .btn-warning:hover { background-color: #d97706; color: #fff; }
        .btn-outline-info { color: #38bdf8; border-color: #38bdf8; }
        .btn-outline-info:hover { background-color: #38bdf8; color: #000; }
        .warning-box {
            background-color: #450a0a;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #38bdf8; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; }
        .table { color: #cbd5e1; font-size: 0.9rem; }
        .table thead th { border-bottom: 1px solid #475569; color: #94a3b8; font-size: 0.8rem; }
        .table td { border-bottom: 1px solid #334155; vertical-align: middle; }
        input.form-control { background-color: #334155; border-color: #475569; color: white; }
        input.form-control:focus { background-color: #334155; color: white; border-color: #38bdf8; box-shadow: none; }
        .staking-btn-group { display: flex; gap: 10px; flex-wrap: nowrap; } /* æ”¹ä¸ºnowrapé˜²æ­¢æ¢è¡Œ */
        .staking-btn-group .btn { 
            flex: 1; 
            min-width: 100px; 
            white-space: nowrap; /* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
            font-size: 0.9rem;
            padding: 0.5rem 0.25rem;
        }
        .badge-duration { 
            background-color: #374151; 
            color: #9ca3af; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.7rem;
            white-space: nowrap; /* é˜²æ­¢å‘¨æœŸæ ‡ç­¾æ¢è¡Œ */
        }
        .countdown { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.75rem;
            display: inline-block;
            white-space: nowrap; /* é˜²æ­¢å€’è®¡æ—¶æ¢è¡Œ */
        }
        .countdown-locked { color: #f87171; }
        .countdown-unlocked { color: #34d399; }
        .align-items-end label.form-label { color: wheat; }
        
        /* è°ƒæ•´è¡¨æ ¼ä¸­ç‰¹å®šåˆ—çš„å­—ä½“å¤§å° */
        .stake-time-cell { font-size: 0.8rem; white-space: nowrap; }
        .remaining-time-cell { font-size: 0.8rem; white-space: nowrap; }
        .status-cell { font-size: 0.8rem; }
        .action-cell { font-size: 0.8rem; white-space: nowrap; }
        .amount-cell { font-size: 0.85rem; font-family: 'Courier New', monospace; white-space: nowrap; }
        
        /* è°ƒæ•´IDåˆ—çš„å­—ä½“å¤§å° */
        .table td:first-child { font-size: 0.85rem; } /* IDåˆ— */
        
        /* è°ƒæ•´è¡¨æ ¼è¡Œé«˜ */
        .table tbody tr { height: 40px; }
        
        /* è°ƒæ•´æ“ä½œæŒ‰é’®å¤§å° */
        .action-cell .btn-sm { 
            padding: 0.15rem 0.4rem; 
            font-size: 0.75rem; 
            line-height: 1.2;
            white-space: nowrap;
        }
        
        /* é€‰é¡¹å¡æ ·å¼ */
        .nav-tabs { border-bottom: 1px solid #334155; }
        .nav-tabs .nav-link { 
            color: #94a3b8; 
            border: 1px solid transparent;
            border-radius: 0.375rem 0.375rem 0 0;
            white-space: nowrap;
        }
        .nav-tabs .nav-link:hover { 
            color: #cbd5e1; 
            border-color: #475569;
        }
        .nav-tabs .nav-link.active { 
            color: #38bdf8; 
            background-color: #1e293b; 
            border-color: #475569 #475569 #1e293b;
        }
        .tab-content { padding-top: 1rem; }
        
        /* åœ°å€æ ·å¼ */
        .address-short { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        /* åˆçº¦åœ°å€æ ·å¼ */
        .contract-address { 
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 500;
            color: #60a5fa;
            word-break: break-all;
            background-color: #1f2937;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        /* ç¼“å­˜çŠ¶æ€æç¤º */
        .cache-status {
            font-size: 0.7rem;
            color: #6b7280;
            margin-left: 10px;
        }
        
        /* è®°å½•é¡¹é«˜äº® */
        @keyframes highlight {
            0% { background-color: #3b82f6; }
            100% { background-color: transparent; }
        }
        .record-highlight {
            animation: highlight 1s ease-out;
        }
        
        /* è‡ªå®šä¹‰é€‰é¡¹å¡æ ·å¼ */
        .stake-sub-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }
        .stake-sub-tab {
            background-color: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .stake-sub-tab:hover {
            background-color: #334155;
            color: #e2e8f0;
        }
        .stake-sub-tab.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        /* æ€»è´¨æŠ¼ç»Ÿè®¡å¡ç‰‡ */
        .total-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .stat-card .label {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .stat-card .value {
            color: #38bdf8;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        /* ç©ºçŠ¶æ€æç¤º */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        /* åˆ†é¡µæ§ä»¶ */
        .pagination-info {
            color: #94a3b8;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <!-- åˆçº¦åœ°å€ä¿¡æ¯ -->
        <div class="alert alert-info mb-4">
            <h6 class="fw-bold">åˆçº¦åœ°å€ä¿¡æ¯</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-2">
                        <small class="text-muted">è´¨æŠ¼åˆçº¦ï¼š</small>
                        <div class="contract-address" id="stakingContractAddress">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-2">
                        <small class="text-muted">USDTåˆçº¦ï¼š</small>
                        <div class="contract-address" id="usdtContractAddress">0x55d398326f99059fF775485246999027B3197955</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é’±åŒ…è¿æ¥ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold">GANAè´¨æŠ¼ç®¡ç†å¹³å°</h3>
            <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
        </div>

        <!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
        <div class="row mb-4 text-center g-2">
            <div class="col-6 col-md-3">
                <div class="card p-3 h-100">
                    <div class="stat-label">æˆ‘çš„ USDT ä½™é¢</div>
                    <div class="stat-value" id="myBalance">0.00</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-3 h-100">
                    <div class="stat-label">å¾…æç°ä½™é¢ (åˆçº¦å†…)</div>
                    <div class="stat-value" id="stakedBalance">0.00</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-3 h-100">
                    <div class="stat-label">åˆçº¦æ€»è´¨æŠ¼</div>
                    <div class="stat-value" id="totalStaked">0.00</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-3 h-100">
                    <div class="stat-label">æ€»è´¨æŠ¼äººæ•°</div>
                    <div class="stat-value" id="totalStakers">0</div>
                </div>
            </div>
        </div>

        <!-- è´¨æŠ¼æ“ä½œåŒºåŸŸ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">å‚ä¸è´¨æŠ¼</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">è´¨æŠ¼é‡‘é¢ (USDT)</label>
                        <input type="number" class="form-control" id="stakeAmount" value="1000" placeholder="è¾“å…¥é‡‘é¢">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label d-block">é€‰æ‹©è´¨æŠ¼å‘¨æœŸ</label>
                        <div class="staking-btn-group">
                            <button class="btn btn-success" onclick="handleStake(0, 1)">1å¤©(0.4%)</button>
                            <button class="btn btn-success" onclick="handleStake(1, 15)">15å¤©(0.8%)</button>
                            <button class="btn btn-success" onclick="handleStake(2, 30)">30å¤©(1.3%)</button>
                        </div>
                    </div>
                </div>
                <div class="mt-2 small text-white">
                    * æ³¨æ„ï¼šä¸åŒè´¨æŠ¼å‘¨æœŸçš„æ—¥åŒ–ç‡å’Œè§£é”æ—¶é—´ä¸åŒ
                </div>
            </div>
        </div>

        <!-- è´¨æŠ¼è®°å½•åŒºåŸŸï¼ˆé€‰é¡¹å¡ï¼‰ -->
        <div class="card">
            <div class="card-body">
                <!-- é€‰é¡¹å¡å¯¼èˆª -->
                <ul class="nav nav-tabs" id="stakeTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="my-stake-tab" data-bs-toggle="tab" data-bs-target="#my-stake" type="button" role="tab" aria-controls="my-stake" aria-selected="true">æˆ‘çš„è´¨æŠ¼è®°å½• <span id="myStakeCount" class="badge bg-secondary ms-1">0</span></button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="all-stake-tab" data-bs-toggle="tab" data-bs-target="#all-stake" type="button" role="tab" aria-controls="all-stake" aria-selected="false">å…¨ç½‘è´¨æŠ¼è®°å½•</button>
                    </li>
                </ul>
                
                <!-- é€‰é¡¹å¡å†…å®¹ -->
                <div class="tab-content" id="stakeTabContent">
                    <!-- æˆ‘çš„è´¨æŠ¼è®°å½• -->
                    <div class="tab-pane fade show active" id="my-stake" role="tabpanel" aria-labelledby="my-stake-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                            <h5 class="card-title mb-0">
                                æˆ‘çš„è´¨æŠ¼è®°å½•
                                <span class="cache-status" id="cacheStatus"></span>
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-light" onclick="refreshData()">åˆ·æ–°å…¨éƒ¨</button>
                                <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleAutoRefresh()" id="autoRefreshBtn">è‡ªåŠ¨åˆ·æ–°: å…³é—­</button>
                            </div>
                        </div>
                        
                        <!-- æˆ‘çš„è´¨æŠ¼å­é€‰é¡¹å¡ -->
                        <div class="stake-sub-tabs">
                            <button class="stake-sub-tab active" onclick="filterMyStakes('all')" id="filter-all">å…¨éƒ¨</button>
                            <button class="stake-sub-tab" onclick="filterMyStakes('active')" id="filter-active">æœªèµå›</button>
                            <button class="stake-sub-tab" onclick="filterMyStakes('inactive')" id="filter-inactive">å·²èµå›</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>é‡‘é¢ (USDT)</th>
                                        <th>è´¨æŠ¼å‘¨æœŸ</th>
                                        <th>è´¨æŠ¼æ—¶é—´</th>
                                        <th>å‰©ä½™æ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="stakeListBody">
                                    <tr><td colspan="7" class="text-center">è¯·è¿æ¥é’±åŒ…æŸ¥çœ‹æ•°æ®</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- å…¨ç½‘è´¨æŠ¼è®°å½• -->
                    <div class="tab-pane fade" id="all-stake" role="tabpanel" aria-labelledby="all-stake-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                            <h5 class="card-title mb-0">å…¨ç½‘è´¨æŠ¼è®°å½•</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-light" onclick="refreshAllStakeData()">åˆ·æ–°å…¨ç½‘æ•°æ®</button>
                            </div>
                        </div>
                        
                        <!-- å…¨ç½‘è´¨æŠ¼ç»Ÿè®¡ -->
                        <div class="total-stats-grid">
                            <div class="stat-card">
                                <div class="label">æ€»è´¨æŠ¼ç”¨æˆ·æ•°</div>
                                <div class="value" id="totalUsers">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">æ´»è·ƒè´¨æŠ¼æ•°é‡</div>
                                <div class="value" id="activeStakes">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">å¹³å‡è´¨æŠ¼é‡‘é¢</div>
                                <div class="value" id="avgStakeAmount">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">æ€»è´¨æŠ¼æ¬¡æ•°</div>
                                <div class="value" id="totalStakeCount">0</div>
                            </div>
                        </div>
                        
                        <!-- å…¨ç½‘è´¨æŠ¼åˆ—è¡¨ -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>åºå·</th>
                                        <th>ç”¨æˆ·åœ°å€</th>
                                        <th>é‡‘é¢ (USDT)</th>
                                        <th>è´¨æŠ¼å‘¨æœŸ</th>
                                        <th>è´¨æŠ¼æ—¶é—´</th>
                                        <th>è§£é”æ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="allStakeListBody">
                                    <tr><td colspan="7" class="text-center">ç‚¹å‡»"åˆ·æ–°å…¨ç½‘æ•°æ®"æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„è´¨æŠ¼è®°å½•</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- åˆ†é¡µæ§ä»¶ -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="pagination-info">
                                æ˜¾ç¤º <span id="currentPage">1</span> / <span id="totalPages">1</span> é¡µï¼Œå…± <span id="totalRecords">0</span> æ¡è®°å½•
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-light" onclick="prevPage()" id="prevPageBtn" disabled>ä¸Šä¸€é¡µ</button>
                                <button class="btn btn-sm btn-outline-light ms-2" onclick="nextPage()" id="nextPageBtn" disabled>ä¸‹ä¸€é¡µ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ Bootstrap JS ç”¨äºé€‰é¡¹å¡åŠŸèƒ½ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const CONFIG = {
            STAKING: "0x72212F35aC448FE7763aA1BFdb360193Fa098E52",
            USDT: "0x55d398326f99059fF775485246999027B3197955",
            TOTAL_STAKE_PAGE_SIZE: 10,
            // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä¼šåœ¨è¿è¡Œæ—¶åŠ¨æ€å‘ç°ç”¨æˆ·
        };
        
        // è´¨æŠ¼å‘¨æœŸé…ç½® (ç§’)
        const STAKE_DURATIONS = {
            0: 86400,      // 1å¤©
            1: 1296000,    // 15å¤©
            2: 2592000     // 30å¤©
        };
        
        const STAKE_DURATION_LABELS = {
            0: "1å¤©",
            1: "15å¤©", 
            2: "30å¤©"
        };
        
        // æ—¥åŒ–ç‡é…ç½®ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        const STAKE_RATES = {
            0: "0.4%",
            1: "0.8%",
            2: "1.3%"
        };
        // ===========================================

        // ABIs
        const ABI_ERC20 = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function symbol() view returns (string)"
        ];

        const ABI_STAKING = [
            {"inputs":[{"internalType":"address","name":"marketingAddress_","type":"address"},{"internalType":"address","name":"devAddress_","type":"address"},{"internalType":"address","name":"threesevenAddress_","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"}],"name":"PRBMath_MulDiv18_Overflow","type":"error"},
            {"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"uint256","name":"denominator","type":"uint256"}],"name":"PRBMath_MulDiv_Overflow","type":"error"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"uint40","name":"timestamp","type":"uint40"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"}],"name":"RewardPaid","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stakeTime","type":"uint256"}],"name":"Staked","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Transfer","type":"event"},
            {"inputs":[],"name":"GANA","outputs":[{"internalType":"contract IGANA","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MIN_STAKE_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"back_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"devAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"isPreacher","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"market_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"marketingAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"maxStakeAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"network1In","outputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint8","name":"index","type":"uint8"}],"name":"principalPlusRewardOfSlot","outputs":[{"internalType":"uint256","name":"reward","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratePerSec","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_gana","type":"address"}],"name":"setGANA","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint160","name":"_amount","type":"uint160"},{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"uint8","name":"_stakeIndex","type":"uint8"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"stakeCount","outputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"sync","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"t_supply","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"tamount","type":"uint160"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"threesevenAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"threeseven_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"unstake","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userStakeRecord","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"amount","type":"uint160"},{"internalType":"bool","name":"status","type":"bool"},{"internalType":"uint8","name":"stakeIndex","type":"uint8"}],"stateMutability":"view","type":"function"}
        ];

        // å…¨å±€å˜é‡
        let provider, signer, userAddress;
        let stakingContract, usdtContract;
        let autoRefreshInterval = null;
        let countdownTimers = {};
        
        // å…¨ç½‘è´¨æŠ¼è®°å½•ç›¸å…³å˜é‡
        let allStakeData = [];           // å­˜å‚¨æ‰€æœ‰ç”¨æˆ·çš„è´¨æŠ¼è®°å½•
        let currentPage = 1;
        let totalPages = 1;
        let isLoadingAllData = false;     // é˜²æ­¢é‡å¤åŠ è½½
        
        // æˆ‘çš„è´¨æŠ¼è®°å½•ç¼“å­˜
        let myStakeRecords = [];
        let lastFetchTime = 0;
        let pendingUpdates = new Set();
        let currentFilter = 'all';         // å½“å‰ç­›é€‰æ¡ä»¶ï¼šall, active, inactive

        // ========== å·¥å…·å‡½æ•° ==========
        // æ ¼å¼åŒ–é‡‘é¢ä¸ºæ•´æ•°ï¼ˆæ— å°æ•°ä½ï¼‰
        function formatAmountInteger(wei) {
            try {
                const val = ethers.formatUnits(wei, 18);
                return Math.floor(parseFloat(val)).toString();
            } catch (e) {
                return "0";
            }
        }

        // æ ¼å¼åŒ–é‡‘é¢ä¸º2ä½å°æ•°ï¼ˆç”¨äºä½™é¢æ˜¾ç¤ºï¼‰
        function formatAmountTwoDecimals(wei) {
            try {
                const val = ethers.formatUnits(wei, 18);
                return parseFloat(val).toFixed(2);
            } catch (e) {
                return "0.00";
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´å‰©ä½™
        function formatTimeRemaining(seconds) {
            if (seconds <= 0) return "å·²è§£é”";
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}å¤©${hours}å°æ—¶`;
            if (hours > 0) return `${hours}å°æ—¶${minutes}åˆ†`;
            if (minutes > 0) return `${minutes}åˆ†`;
            return `${Math.floor(seconds)}ç§’`;
        }
        
        // æ ¼å¼åŒ–è´¨æŠ¼æ—¶é—´
        function formatStakeTime(timestamp) {
            try {
                const date = new Date(timestamp * 1000);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return 'ä»Šå¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                return "æ—¶é—´é”™è¯¯";
            }
        }
        
        // æ ¼å¼åŒ–è§£é”æ—¶é—´
        function formatUnlockTime(timestamp) {
            try {
                const date = new Date(timestamp * 1000);
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return "æ—¶é—´é”™è¯¯";
            }
        }
        
        // ç¼©çŸ­åœ°å€æ˜¾ç¤º
        function shortenAddress(address) {
            if (!address) return '';
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }

        // ========== é’±åŒ…è¿æ¥ ==========
        async function connectWallet() {
            if (!window.ethereum) {
                alert("è¯·å®‰è£… MetaMask!");
                return;
            }
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('connectBtn').innerText = shortenAddress(userAddress);
                document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

                stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
                usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

                await refreshData();
                
                // è‡ªåŠ¨åŠ è½½å…¨ç½‘æ•°æ®
                refreshAllStakeData();
                
            } catch (error) {
                console.error("è¿æ¥å¤±è´¥:", error);
                alert("è¿æ¥é’±åŒ…å¤±è´¥: " + (error.message || error));
            }
        }

        // ========== æˆ‘çš„è´¨æŠ¼è®°å½•ç›¸å…³ ==========
        function updateCacheStatus() {
            const cacheStatusEl = document.getElementById('cacheStatus');
            if (!cacheStatusEl) return;
            
            const now = Date.now();
            
            if (lastFetchTime === 0) {
                cacheStatusEl.textContent = 'æœªåŠ è½½';
                return;
            }
            
            if (pendingUpdates.size > 0) {
                cacheStatusEl.textContent = `ğŸ”„ æ›´æ–°ä¸­ (${pendingUpdates.size}æ¡)`;
            } else {
                const seconds = Math.round((now - lastFetchTime) / 1000);
                cacheStatusEl.textContent = `âœ… ${seconds}ç§’å‰æ›´æ–°`;
            }
        }

        async function updateSingleRecord(index) {
            if (!userAddress || !stakingContract) return null;
            
            try {
                const record = await stakingContract.userStakeRecord(userAddress, index);
                
                const now = Math.floor(Date.now() / 1000);
                const amount = formatAmountInteger(record[1]);
                const stakeTime = Number(record[0]);
                const isActive = record[2];
                const stakeIndex = Number(record[3]);
                const durationSeconds = STAKE_DURATIONS[stakeIndex] || 86400;
                const unlockTime = stakeTime + durationSeconds;
                const timeRemaining = unlockTime - now;
                
                const updatedRecord = {
                    index,
                    amount,
                    stakeTime,
                    isActive,
                    stakeIndex,
                    unlockTime,
                    timeRemaining
                };
                
                const existingIndex = myStakeRecords.findIndex(r => r.index === index);
                if (existingIndex >= 0) {
                    myStakeRecords[existingIndex] = updatedRecord;
                } else {
                    myStakeRecords.push(updatedRecord);
                }
                
                myStakeRecords.sort((a, b) => b.index - a.index);
                
                return updatedRecord;
            } catch (error) {
                console.error(`æ›´æ–°è®°å½• ${index} å¤±è´¥:`, error);
                return null;
            }
        }

        async function refreshChangedRecords() {
            if (!userAddress || !stakingContract) return;
            
            const changedIndices = Array.from(pendingUpdates);
            if (changedIndices.length === 0) return;
            
            updateCacheStatus();
            
            const updatePromises = changedIndices.map(index => updateSingleRecord(parseInt(index)));
            await Promise.all(updatePromises);
            
            pendingUpdates.clear();
            
            renderStakeListFromCache();
            updateCacheStatus();
        }

        function renderStakeListFromCache() {
            const tbody = document.getElementById('stakeListBody');
            if (!tbody) return;
            
            // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤è®°å½•
            let filteredRecords = myStakeRecords;
            if (currentFilter === 'active') {
                filteredRecords = myStakeRecords.filter(r => !r.isActive);
            } else if (currentFilter === 'inactive') {
                filteredRecords = myStakeRecords.filter(r => r.isActive);
            }
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center empty-state">æš‚æ— è´¨æŠ¼è®°å½•</td></tr>';
                document.getElementById('myStakeCount').textContent = myStakeRecords.length;
                return;
            }
            
            const now = Math.floor(Date.now() / 1000);
            let html = '';
            
            filteredRecords.forEach(record => {
                const isLocked = record.timeRemaining > 0 && !record.isActive;
                const isUnlocked = record.timeRemaining <= 0 && !record.isActive;
                const durationLabel = STAKE_DURATION_LABELS[record.stakeIndex] || "æœªçŸ¥";
                const stakeTimeStr = formatStakeTime(record.stakeTime);
                
                let statusHtml = '';
                let actionHtml = '';
                let timeRemainingHtml = '';

                if (record.isActive) {
                    statusHtml = '<span class="text-muted">å·²èµå›</span>';
                    actionHtml = '-';
                    timeRemainingHtml = '<span class="text-muted">-</span>';
                } else {
                    if (isLocked) {
                        statusHtml = '<span class="text-danger">é”ä»“ä¸­</span>';
                        actionHtml = `<button class="btn btn-sm btn-secondary" disabled>é”ä»“ä¸­</button>`;
                        timeRemainingHtml = `<span class="countdown countdown-locked" id="countdown-${record.index}">${formatTimeRemaining(record.timeRemaining)}</span>`;
                        
                        startCountdown(record.index, record.timeRemaining);
                    } else if (isUnlocked) {
                        statusHtml = '<span class="text-success">å¯èµå›</span>';
                        actionHtml = `<button class="btn btn-sm btn-warning" id="unstake-btn-${record.index}" onclick="handleUnstake(${record.index})">èµå›</button>`;
                        timeRemainingHtml = '<span class="countdown countdown-unlocked">å·²è§£é”</span>';
                    } else {
                        statusHtml = '<span class="text-warning">æœªçŸ¥</span>';
                        actionHtml = '-';
                        timeRemainingHtml = '-';
                    }
                }

                html += `
                    <tr id="record-row-${record.index}" ${pendingUpdates.has(record.index.toString()) ? 'class="record-highlight"' : ''}>
                        <td>${record.index}</td>
                        <td class="amount-cell">${record.amount}</td>
                        <td><span class="badge-duration">${durationLabel}</span></td>
                        <td class="stake-time-cell">${stakeTimeStr}</td>
                        <td class="remaining-time-cell">${timeRemainingHtml}</td>
                        <td class="status-cell">${statusHtml}</td>
                        <td class="action-cell">${actionHtml}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            document.getElementById('myStakeCount').textContent = myStakeRecords.length;
            
            setTimeout(() => {
                document.querySelectorAll('.record-highlight').forEach(el => {
                    el.classList.remove('record-highlight');
                });
            }, 1000);
        }

        // ========== è´¨æŠ¼æ“ä½œ ==========
        async function handleStake(stakeIndex, durationDays) {
            if (!userAddress) return alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            
            const amountStr = document.getElementById('stakeAmount').value;
            if (!amountStr || parseFloat(amountStr) <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
            
            const amountWei = ethers.parseUnits(amountStr, 18);
            
            const buttons = document.querySelectorAll('.staking-btn-group .btn');
            const originalTexts = [];
            
            try {
                buttons.forEach(btn => {
                    originalTexts.push(btn.textContent);
                    btn.disabled = true;
                });
                
                const currentBtn = event.target;
                currentBtn.textContent = "æ£€æŸ¥ä¸­...";

                // æ£€æŸ¥æˆæƒ
                currentBtn.textContent = "æˆæƒä¸­...";
                const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
                if (allowance < amountWei) {
                    const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256); 
                    await txApprove.wait();
                }

                // å‘èµ·è´¨æŠ¼
                currentBtn.textContent = "è´¨æŠ¼ä¸­...";
                const txStake = await stakingContract.stake(amountWei, 0, stakeIndex);
                await txStake.wait();
                
                // è·å–æ–°è®°å½•çš„ç´¢å¼•
                const newCount = await stakingContract.stakeCount(userAddress);
                const newIndex = Number(newCount) - 1;
                
                pendingUpdates.add(newIndex.toString());
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                await refreshStatsOnly();
                
                // åªæ›´æ–°å˜åŒ–çš„è®°å½•
                await refreshChangedRecords();
                
                alert(`è´¨æŠ¼æˆåŠŸï¼å‘¨æœŸï¼š${durationDays}å¤©`);

            } catch (error) {
                console.error(error);
                if(error.reason) alert("åˆçº¦é”™è¯¯: " + error.reason);
                else if(error.message.includes("User denied")) alert("ç”¨æˆ·å–æ¶ˆäº¤æ˜“");
                else if(error.message.includes("insufficient allowance")) alert("è¯·å…ˆæˆæƒUSDT");
                else alert("è´¨æŠ¼å¤±è´¥: " + (error.message || error));
            } finally {
                buttons.forEach((btn, index) => {
                    btn.disabled = false;
                    btn.textContent = originalTexts[index];
                });
            }
        }

        // ========== èµå›æ“ä½œ ==========
        async function handleUnstake(index) {
            if (!userAddress) return;
            
            const btn = document.getElementById(`unstake-btn-${index}`);
            if(btn) {
                btn.disabled = true;
                btn.innerText = "èµå›ä¸­...";
            }

            try {
                const tx = await stakingContract.unstake(index);
                await tx.wait();
                
                pendingUpdates.add(index.toString());
                
                await refreshStatsOnly();
                await refreshChangedRecords();
                
                alert("èµå›æˆåŠŸï¼");

            } catch (error) {
                console.error(error);
                if(btn) {
                    btn.disabled = false;
                    btn.innerText = "èµå›";
                }
                
                if(error.reason) alert("åˆçº¦é”™è¯¯: " + error.reason);
                else if(error.message.includes("User denied")) alert("ç”¨æˆ·å–æ¶ˆäº¤æ˜“");
                else alert("èµå›å¤±è´¥: " + (error.message || error));
            }
        }

        // ========== åˆ·æ–°ç»Ÿè®¡æ•°æ® ==========
        async function refreshStatsOnly() {
            if (!userAddress) return;
            
            try {
                const [myBal, stakedBal, totalStaked] = await Promise.all([
                    usdtContract.balanceOf(userAddress),
                    stakingContract.balanceOf(userAddress),
                    stakingContract.totalSupply()
                ]);
                
                document.getElementById('myBalance').innerText = formatAmountTwoDecimals(myBal);
                document.getElementById('stakedBalance').innerText = formatAmountTwoDecimals(stakedBal);
                document.getElementById('totalStaked').innerText = formatAmountTwoDecimals(totalStaked);
                
            } catch (error) {
                console.error("ç»Ÿè®¡åˆ·æ–°å¤±è´¥:", error);
            }
        }

        // ========== åˆ·æ–°æˆ‘çš„æ‰€æœ‰æ•°æ® ==========
        async function refreshData() {
            if (!userAddress) return;
            
            const btn = document.querySelector('button[onclick="refreshData()"]');
            const originalText = btn.innerText;
            btn.innerText = "åŠ è½½ä¸­...";
            
            try {
                await refreshStatsOnly();
                
                const newCount = await stakingContract.stakeCount(userAddress);
                
                // å¦‚æœæ•°é‡å˜åŒ–äº†ï¼Œæ ‡è®°æ‰€æœ‰è®°å½•éœ€è¦æ›´æ–°
                if (myStakeRecords.length !== Number(newCount)) {
                    for (let i = 0; i < Number(newCount); i++) {
                        pendingUpdates.add(i.toString());
                    }
                }
                
                await refreshChangedRecords();
                
                lastFetchTime = Date.now();
                updateCacheStatus();
                
            } catch (error) {
                console.error("æ•°æ®åŠ è½½é”™è¯¯:", error);
            } finally {
                btn.innerText = originalText;
            }
        }

        // ========== ç­›é€‰æˆ‘çš„è´¨æŠ¼è®°å½• ==========
        function filterMyStakes(filter) {
            currentFilter = filter;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('filter-all').classList.remove('active');
            document.getElementById('filter-active').classList.remove('active');
            document.getElementById('filter-inactive').classList.remove('active');
            
            if (filter === 'all') {
                document.getElementById('filter-all').classList.add('active');
            } else if (filter === 'active') {
                document.getElementById('filter-active').classList.add('active');
            } else if (filter === 'inactive') {
                document.getElementById('filter-inactive').classList.add('active');
            }
            
            renderStakeListFromCache();
        }

        // ========== å€’è®¡æ—¶ ==========
        function startCountdown(id, initialSeconds) {
            let remaining = initialSeconds;
            const countdownElement = document.getElementById(`countdown-${id}`);
            
            if (!countdownElement) return;
            
            const timer = setInterval(() => {
                remaining--;
                
                if (remaining <= 0) {
                    clearInterval(timer);
                    pendingUpdates.add(id.toString());
                    refreshChangedRecords();
                    return;
                }
                
                if (countdownElement) {
                    countdownElement.textContent = formatTimeRemaining(remaining);
                }
            }, 1000);
            
            countdownTimers[id] = timer;
        }

        // ========== å…¨ç½‘è´¨æŠ¼è®°å½•ç›¸å…³ ==========
        async function refreshAllStakeData() {
            if (!stakingContract) {
                alert("è¯·å…ˆè¿æ¥é’±åŒ…");
                return;
            }
            
            if (isLoadingAllData) return;
            
            const btn = document.querySelector('button[onclick="refreshAllStakeData()"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "åŠ è½½ä¸­...";
            isLoadingAllData = true;
            
            try {
                allStakeData = [];
                
                // ä»Stakedäº‹ä»¶ä¸­è·å–æ‰€æœ‰è´¨æŠ¼è®°å½•
                const filter = stakingContract.filters.Staked();
                const events = await stakingContract.queryFilter(filter, 0, 'latest');
                
                // å¤„ç†æ¯ä¸ªäº‹ä»¶
                for (const event of events) {
                    try {
                        const user = event.args[1]; // user address
                        const amount = event.args[0]; // amount
                        const stakeIndex = Number(event.args[2]); // index
                        const stakeTime = Number(event.args[3]); // stakeTime
                        
                        // æ£€æŸ¥è¿™æ¡è®°å½•æ˜¯å¦å·²èµå›
                        const record = await stakingContract.userStakeRecord(user, stakeIndex);
                        const isActive = record[2];
                        
                        allStakeData.push({
                            userAddress: user,
                            amount: amount,
                            stakeTime: stakeTime,
                            isActive: isActive,
                            stakeIndex: stakeIndex,
                            unlockTime: stakeTime + (STAKE_DURATIONS[stakeIndex] || 86400)
                        });
                    } catch (e) {
                        console.error("å¤„ç†äº‹ä»¶å¤±è´¥:", e);
                    }
                }
                
                // æŒ‰è´¨æŠ¼æ—¶é—´å€’åºæ’åº
                allStakeData.sort((a, b) => b.stakeTime - a.stakeTime);
                
                // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                calculateAllStats();
                
                // æ¸²æŸ“ç¬¬ä¸€é¡µ
                currentPage = 1;
                renderAllStakeList();
                updatePagination();
                
                btn.innerText = "åˆ·æ–°æˆåŠŸ";
                setTimeout(() => {
                    btn.innerText = originalText;
                }, 1500);
                
            } catch (error) {
                console.error("è·å–å…¨ç½‘è´¨æŠ¼æ•°æ®å¤±è´¥:", error);
                btn.innerText = "åˆ·æ–°å¤±è´¥";
                setTimeout(() => {
                    btn.innerText = originalText;
                }, 1500);
            } finally {
                btn.disabled = false;
                isLoadingAllData = false;
            }
        }

        function calculateAllStats() {
            if (allStakeData.length === 0) {
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('activeStakes').textContent = '0';
                document.getElementById('avgStakeAmount').textContent = '0';
                document.getElementById('totalStakeCount').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }
            
            // å”¯ä¸€ç”¨æˆ·æ•°
            const uniqueUsers = new Set();
            allStakeData.forEach(record => uniqueUsers.add(record.userAddress));
            document.getElementById('totalUsers').textContent = uniqueUsers.size;
            
            // æ´»è·ƒè´¨æŠ¼æ•°ï¼ˆæœªèµå›ï¼‰
            const activeStakes = allStakeData.filter(record => !record.isActive).length;
            document.getElementById('activeStakes').textContent = activeStakes;
            
            // æ€»è´¨æŠ¼æ¬¡æ•°
            document.getElementById('totalStakeCount').textContent = allStakeData.length;
            document.getElementById('totalRecords').textContent = allStakeData.length;
            
            // å¹³å‡è´¨æŠ¼é‡‘é¢
            const totalAmount = allStakeData.reduce((sum, record) => {
                return sum + parseFloat(ethers.formatUnits(record.amount, 18));
            }, 0);
            
            const avgAmount = Math.floor(totalAmount / allStakeData.length);
            document.getElementById('avgStakeAmount').textContent = avgAmount.toString();
        }

        function renderAllStakeList() {
            const tbody = document.getElementById('allStakeListBody');
            
            if (allStakeData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center empty-state">æš‚æ— è´¨æŠ¼è®°å½•</td></tr>';
                return;
            }
            
            const startIndex = (currentPage - 1) * CONFIG.TOTAL_STAKE_PAGE_SIZE;
            const endIndex = Math.min(startIndex + CONFIG.TOTAL_STAKE_PAGE_SIZE, allStakeData.length);
            const pageData = allStakeData.slice(startIndex, endIndex);
            
            let html = '';
            
            pageData.forEach((record, index) => {
                const globalIndex = startIndex + index + 1;
                const amount = formatAmountInteger(record.amount);
                const stakeTimeStr = formatStakeTime(record.stakeTime);
                const unlockTimeStr = formatUnlockTime(record.unlockTime);
                const durationLabel = STAKE_DURATION_LABELS[record.stakeIndex] || "æœªçŸ¥";
                const status = record.isActive ? "å·²èµå›" : "è´¨æŠ¼ä¸­";
                const statusClass = record.isActive ? "text-muted" : "text-success";
                const isCurrentUser = record.userAddress.toLowerCase() === (userAddress || '').toLowerCase();
                
                html += `
                    <tr>
                        <td>${globalIndex}</td>
                        <td>
                            <span class="address-short">${shortenAddress(record.userAddress)}</span>
                            ${isCurrentUser ? '<span class="badge bg-info ms-1">æˆ‘</span>' : ''}
                        </td>
                        <td class="amount-cell">${amount}</td>
                        <td><span class="badge-duration">${durationLabel}</span></td>
                        <td class="stake-time-cell">${stakeTimeStr}</td>
                        <td class="stake-time-cell">${unlockTimeStr}</td>
                        <td class="status-cell"><span class="${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updatePagination() {
            totalPages = Math.ceil(allStakeData.length / CONFIG.TOTAL_STAKE_PAGE_SIZE);
            
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages || 1;
            
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderAllStakeList();
                updatePagination();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderAllStakeList();
                updatePagination();
            }
        }

        // ========== è‡ªåŠ¨åˆ·æ–° ==========
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(async () => {
                if (userAddress) {
                    const newCount = await stakingContract.stakeCount(userAddress);
                    
                    if (myStakeRecords.length !== Number(newCount)) {
                        for (let i = 0; i < Number(newCount); i++) {
                            if (!myStakeRecords.some(r => r.index === i)) {
                                pendingUpdates.add(i.toString());
                            }
                        }
                    }
                    
                    await refreshChangedRecords();
                    await refreshStatsOnly();
                    
                    const activeTab = document.querySelector('#stakeTab .nav-link.active');
                    if (activeTab && activeTab.id === 'all-stake-tab') {
                        await refreshAllStakeData();
                    }
                }
            }, 30000);
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = "è‡ªåŠ¨åˆ·æ–°: å…³é—­";
                btn.classList.remove('btn-info');
                btn.classList.add('btn-outline-info');
            } else {
                startAutoRefresh();
                btn.textContent = "è‡ªåŠ¨åˆ·æ–°: å¼€å¯";
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-info');
            }
        }

        // ========== æ¸…ç† ==========
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            Object.keys(countdownTimers).forEach(id => {
                clearInterval(countdownTimers[id]);
            });
        });

        // ========== åˆå§‹åŒ– ==========
        window.addEventListener('load', () => {
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            connectWallet();
                        }
                    });
            }
            
            document.getElementById('stakingContractAddress').textContent = CONFIG.STAKING;
            document.getElementById('usdtContractAddress').textContent = CONFIG.USDT;
        });
    </script>
</body>
</html>
